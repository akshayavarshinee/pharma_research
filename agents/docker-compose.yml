version: "3.8"

services:
  pharma_researcher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pharma_researcher
    volumes:
      # Mount output directory for generated reports and visualizations
      - ./output:/app/output
      # Mount data directory if needed
      - ./data:/app/data:ro
      # Mount knowledge directory if needed
      - ./knowledge:/app/knowledge:ro
    environment:
      # Load environment variables from .env file
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SERPER_API_KEY=${SERPER_API_KEY}
      - PATENTS_VIEW_API_KEY=${PATENTS_VIEW_API_KEY}
      # Add other API keys as needed
    env_file:
      - .env
    networks:
      - pharma_network
    # Resource limits for safety
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 2G
    # Security options
    security_opt:
      - no-new-privileges:true
    # Read-only root filesystem (except mounted volumes)
    read_only: false
    # Prevent privilege escalation
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    # Restart policy
    restart: unless-stopped
    # Command to run
    command: python -m pharma_researcher.main

  # Optional: Add a service for Jupyter notebook for interactive analysis
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pharma_jupyter
    volumes:
      - ./output:/app/output
      - ./data:/app/data
      - ./notebooks:/app/notebooks
    ports:
      - "8888:8888"
    environment:
      - JUPYTER_ENABLE_LAB=yes
    env_file:
      - .env
    networks:
      - pharma_network
    command: jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
    profiles:
      - jupyter # Only start with: docker-compose --profile jupyter up

networks:
  pharma_network:
    driver: bridge
